# Work Log - 2026-02-17

## Summary
- Implemented hybrid OCR quality improvements in backend (Vision OCR + Gemini normalization + diagnostics).
- Added confidence calibration and pipeline coverage diagnostics for scan reliability tracking.
- Expanded item coverage controls and tightened prompt behavior to reduce over-inference.
- Performed major Scan/Processing/Show-to-Staff UI refinements, including carousel, copy updates, and layout balancing.
- Switched scan carousel from remote image URLs to local drawable assets.

## Detailed Work Completed
1. Backend OCR pipeline upgrade
- Added `OCR_PIPELINE_MODE` support (`hybrid` and `vision_only`) in `backend/app/main.py`.
- Implemented Gemini OCR normalization pass before structured parsing in hybrid mode.
- Added safe fallback behavior: if normalization fails, pipeline continues with raw Vision OCR text.

2. Diagnostics and confidence calibration
- Added per-item `ocr_diagnostics` to response items.
- Added scoring helpers for OCR/source matching and confidence blending.
- Added weak-signal diagnostics flags (for example low OCR match or style-inference risk).
- Added request-level `pipeline_diagnostics` with:
  - estimated OCR candidate count,
  - returned item count,
  - coverage ratio.

3. Coverage and prompt behavior controls
- Added `MAX_MENU_ITEMS` env control (1..20, default 10).
- Updated parsing prompt to discourage unsupported style inference (for example adding serving style terms not present in OCR text).
- Increased practical extraction coverage on multi-item menu board tests.

4. Backend docs/config updates
- Updated `backend/.env.example` with:
  - `OCR_PIPELINE_MODE=hybrid`
  - `MAX_MENU_ITEMS=10`
- Updated `backend/README.md` to document OCR modes, coverage diagnostics, and new config fields.

5. Scan screen UI updates
- Removed/re-added top branding block based on requested layout iterations.
- Tuned vertical alignment and top spacing.
- Added guidance text for better scan accuracy (scan smaller sections).
- Added middle image carousel between intro and scan action card.
- Converted carousel to auto-scroll and disabled user interaction.
- Switched carousel data source from remote URLs to local drawables:
  - `sushi.png`
  - `ramen.png`
  - `tempura.png`
  - `kushi.png`
- Tuned carousel sizing to show 3 images on phone screens.
- Removed card frame styling around carousel images to keep sticker-like presentation.

6. Processing screen updates
- Removed subtitle text under "Reading Japanese Menu".
- Updated processing copy:
  - from "Identifying dishes and generating tourist-friendly descriptions..."
  - to "Identifying dishes and generating descriptions..."
- Added decorative `restaurant.png` image in lower area and tuned its size/position.

7. Show-to-Staff screen updates
- Removed the top Show-to-Staff header card for this screen.
- Kept Japanese request card and added:
  - `ありがとうございました！`
- Added new English request card with:
  - "I'd like this, please."
  - English selected item line
  - "Thank you so much!"
- Updated navigation wiring so "Selected item" uses English title instead of Japanese text.
- Added large decorative `macha.png` image in lower area.

## Validation Performed
- Repeated backend runtime validation via `/v1/scan_menu` with real menu photos.
- Verified hybrid diagnostics and coverage fields in API response payloads.
- Verified Android UI changes through iterative build/install and screenshot-based review.

## Current State at End of Day
- Hybrid OCR pipeline is active and producing improved extraction behavior with diagnostics.
- Scan, Processing, and Show-to-Staff screens now match updated UX direction.
- Local drawable-based visual assets are integrated and stable for carousel/decorative usage.

