# Work Log - 2026-02-16

## Summary
- Investigated and resolved the image retrieval blocker caused by Google Custom Search API deprecation/access issues.
- Added backend provider abstraction for image retrieval and integrated Vertex AI Search.
- Fixed Vertex authentication and IAM permission issues for backend service account calls.
- Implemented Android Detail screen real image rendering with Coil (including fallback behavior).
- Updated Detail UI layout to show one large image and moved "Show to staff" to a separate block below.

## Detailed Work Completed
1. Branch and workflow progression
- Confirmed clean branch state and continued work on `feature/image-retrieval`.

2. Root-cause analysis for image retrieval failure
- Verified Google Custom Search JSON API calls returned 403.
- Confirmed platform notice: new users cannot newly onboard to Custom Search JSON API.
- Decided to migrate retrieval path to Vertex AI Search.

3. Backend image provider architecture improvements
- Added `IMAGE_SEARCH_PROVIDER` routing (`none`, `cse`, `vertex`) in `backend/app/main.py`.
- Preserved safe fallback behavior so image search failures do not break OCR/translation results.
- Updated config docs and env templates:
  - `backend/.env.example`
  - `backend/README.md`

4. Vertex AI Search integration
- Implemented Vertex access-token flow via ADC/service account in `backend/app/main.py`.
- Added Discovery Engine search call using:
  - `GCP_PROJECT_ID`
  - `VERTEX_SEARCH_LOCATION`
  - `VERTEX_SEARCH_APP_ID`
- Added `google-auth` and `requests` dependencies in `backend/requirements.txt`.
- Added backend logging for Vertex failures and payload-shape diagnosis.

5. Vertex result parsing/filtering hardening
- Reworked parsing to recursively inspect Vertex result payloads.
- Prioritized image-like URL fields and filtered non-image page links.
- Added heuristics for direct image URLs (e.g., jpg/png/webp).

6. Android Detail image UX implementation
- Replaced static placeholders with Coil-based remote image rendering in:
  - `android/app/src/main/java/com/menulens/app/ui/screens/DetailScreen.kt`
- Added:
  - empty-image fallback state,
  - image error fallback,
  - tap-to-expand dialog.
- Added retry behavior across multiple image URLs (auto-fallback to next URL if first fails).
- Updated layout to:
  - show one large image block only,
  - place "Show to staff" in a separate block below the content card.

7. Secrets hygiene
- Added `backend/keys/` to root `.gitignore` to prevent service-account key commits.

## Validation Performed
- Backend syntax checks on `backend/app/main.py` after each major patch.
- FastAPI `/v1/scan_menu` validated repeatedly with live requests.
- Confirmed end-to-end scan returns valid OCR + Gemini output.
- Confirmed Vertex retrieval path returns image candidates after IAM fixes.
- Confirmed updated Android screen renders live image attempts and new layout.

## Issues Encountered and Resolved
- CSE 403 (`PERMISSION_DENIED`) due API access/deprecation constraints -> migrated to Vertex path.
- Gemini 403/400 (`API_KEY_INVALID`) during setup -> corrected API key usage and environment setup.
- Vertex 403 IAM (`discoveryengine.servingConfigs.search`) -> resolved by granting Discovery Engine permissions.
- Android/Gradle local compile command hit Java version mismatch (`25.0.1`) in terminal environment -> identified need to run with JDK 17 for local Gradle tasks.

## Current State at End of Day
- Scan pipeline is functional for OCR + translation + item generation.
- Vertex image retrieval is integrated and no longer blocked by CSE.
- Android Detail page now supports real image rendering flow and fallback behavior.
- Some image URLs can still fail depending on source accessibility/quality; fallback handling is in place.

## Next Priorities (Proposed)
1. Improve OCR accuracy with stronger AI
- Evaluate stronger OCR stack than current Vision-only baseline:
  - Gemini vision-first extraction (image-to-structured JSON),
  - or hybrid: Vision OCR + Gemini correction/normalization pass.
- Add confidence scoring and per-item OCR diagnostics to identify weak outputs.

2. Improve image retrieval relevance using generative AI
- Use LLM-based re-ranking on retrieved candidates:
  - query expansion from JP text + EN title + cuisine context,
  - semantic filtering for "dish photo" vs article/packaging/noise.
- Consider multimodal validation:
  - retrieve N candidates,
  - score candidates with Gemini for dish match confidence,
  - return top 1-2 validated image URLs.

3. Improve output reliability and observability
- Add structured stage-level telemetry:
  - OCR, parse, image retrieve, image filter/rerank.
- Add explicit error codes in response for UI diagnostics (`IMAGE_SOURCE_BLOCKED`, `NO_VALID_IMAGE_URL`, etc.).

4. Security and cleanup
- Rotate any exposed API keys and service credentials.
- Keep `.env.example` placeholder-only and verify no secrets are tracked in git history.

